<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â°óÈ¥âÁï´Êùø - Âø´Ê®ÇÂ≠∏ÁøíÊ®ÇÂúí</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .drawing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            max-width: 100%;
        }

        .canvas-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 10px;
            margin: 10px 0;
            touch-action: none;
        }

        #drawing-canvas {
            border: 4px solid #FFD700;
            border-radius: 15px;
            cursor: crosshair;
            background: white;
            touch-action: none;
        }

        .tools-panel {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            max-width: 600px;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .color-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-btn:hover {
            transform: scale(1.15);
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.2);
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.5);
        }

        .brush-sizes {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .size-btn {
            background: #333;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .size-btn:hover {
            transform: scale(1.2);
        }

        .size-btn.active {
            border-color: #FF6B6B;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.5);
        }

        .size-small {
            width: 20px;
            height: 20px;
        }

        .size-medium {
            width: 30px;
            height: 30px;
        }

        .size-large {
            width: 40px;
            height: 40px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 15px 25px;
            font-size: 1.3rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-clear {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            color: white;
        }

        .btn-eraser {
            background: linear-gradient(135deg, #95A5A6, #7F8C8D);
            color: white;
        }

        .btn-eraser.active {
            background: linear-gradient(135deg, #F39C12, #E67E22);
        }

        .btn-save {
            background: linear-gradient(135deg, #27AE60, #1E8449);
            color: white;
        }

        .btn-undo {
            background: linear-gradient(135deg, #3498DB, #2980B9);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .mode-indicator {
            font-size: 1.2rem;
            padding: 10px 20px;
            background: linear-gradient(135deg, #FFE66D, #FFF9E6);
            border-radius: 20px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #333;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .color-btn {
                width: 40px;
                height: 40px;
            }

            .action-btn {
                padding: 12px 20px;
                font-size: 1.1rem;
            }

            .size-small {
                width: 16px;
                height: 16px;
            }

            .size-medium {
                width: 24px;
                height: 24px;
            }

            .size-large {
                width: 32px;
                height: 32px;
            }
        }

        @media (max-width: 480px) {
            .color-btn {
                width: 35px;
                height: 35px;
            }

            .action-btn {
                padding: 10px 15px;
                font-size: 1rem;
            }
        }

        /* ÂÑ≤Â≠òÊàêÂäüÂãïÁï´ */
        .save-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(39, 174, 96, 0.95);
            color: white;
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: bold;
            z-index: 1000;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>üé® Â°óÈ¥âÁï´Êùø</h1>
    </header>
    <main>
        <div th:replace="~{fragments :: nav('/games/menu', '‚Üê ‰∏ä‰∏ÄÈ†Å')}"></div>

        <div class="drawing-container">
            <div class="mode-indicator" id="mode-indicator">üñåÔ∏è Áï´Á≠ÜÊ®°Âºè</div>

            <div class="canvas-wrapper">
                <canvas id="drawing-canvas" width="600" height="450"></canvas>
            </div>

            <div class="tools-panel">
                <div class="color-palette" id="color-palette">
                    <!-- È°èËâ≤ÊåâÈàïÁî± JS ÁîüÊàê -->
                </div>
            </div>

            <div class="tools-panel">
                <div class="brush-sizes">
                    <span style="font-weight: bold;">Á≠ÜÂà∑Â§ßÂ∞èÔºö</span>
                    <button class="size-btn size-small" data-size="5" title="Â∞è"></button>
                    <button class="size-btn size-medium active" data-size="12" title="‰∏≠"></button>
                    <button class="size-btn size-large" data-size="24" title="Â§ß"></button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn btn-eraser" id="eraser-btn" onclick="toggleEraser()">üßΩ Ê©°ÁöÆÊì¶</button>
                <button class="action-btn btn-undo" onclick="undoLast()">‚Ü©Ô∏è Âæ©Âéü</button>
                <button class="action-btn btn-clear" onclick="clearCanvas()">üóëÔ∏è Ê∏ÖÈô§</button>
                <button class="action-btn btn-save" onclick="saveDrawing()">üíæ ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments :: game-scripts}"></th:block>

    <script>
        // È°èËâ≤ÂÆöÁæ©
        const colors = [
            { name: 'Á¥ÖËâ≤', hex: '#E74C3C' },
            { name: 'Ê©òËâ≤', hex: '#E67E22' },
            { name: 'ÈªÉËâ≤', hex: '#F1C40F' },
            { name: 'Á∂†Ëâ≤', hex: '#27AE60' },
            { name: 'ËóçËâ≤', hex: '#3498DB' },
            { name: 'Á¥´Ëâ≤', hex: '#9B59B6' },
            { name: 'Á≤âÁ¥Ö', hex: '#FF69B4' },
            { name: 'Ê£ïËâ≤', hex: '#8B4513' },
            { name: 'ÈªëËâ≤', hex: '#2C3E50' },
            { name: 'ÁôΩËâ≤', hex: '#FFFFFF' }
        ];

        // Áï´Â∏ÉÁõ∏ÈóúËÆäÊï∏
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#2C3E50';
        let brushSize = 12;
        let isEraser = false;
        let history = [];
        let historyIndex = -1;

        // ÂàùÂßãÂåñ
        function init() {
            setupCanvas();
            generateColorPalette();
            setupEventListeners();
            saveState();

            if (typeof RewardSystem !== 'undefined') {
                RewardSystem.createStarDisplay();
            }
            if (typeof GameAudio !== 'undefined') {
                GameAudio.speak('Ê≠°Ëøé‰æÜÂà∞Â°óÈ¥âÁï´ÊùøÔºÅÈÅ∏ÊìáÈ°èËâ≤ÈñãÂßãÁï´Áï´ÂêßÔºÅ');
            }
        }

        // Ë®≠ÁΩÆÁï´Â∏ÉÂ∞∫ÂØ∏ÔºàÈüøÊáâÂºèÔºâ
        function setupCanvas() {
            const container = canvas.parentElement;
            const maxWidth = Math.min(600, window.innerWidth - 40);
            const ratio = 450 / 600;

            canvas.width = maxWidth;
            canvas.height = maxWidth * ratio;

            // Ë®≠ÂÆöÂàùÂßãËÉåÊôØÁÇ∫ÁôΩËâ≤
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // ÁîüÊàêÈ°èËâ≤ÈÅ∏ÊìáÂô®
        function generateColorPalette() {
            const palette = document.getElementById('color-palette');
            colors.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = 'color-btn' + (color.hex === currentColor ? ' active' : '');
                btn.style.backgroundColor = color.hex;
                if (color.hex === '#FFFFFF') {
                    btn.style.border = '4px solid #ddd';
                }
                btn.title = color.name;
                btn.onclick = () => selectColor(color.hex, btn);
                palette.appendChild(btn);
            });
        }

        // ÈÅ∏ÊìáÈ°èËâ≤
        function selectColor(hex, btn) {
            currentColor = hex;
            isEraser = false;

            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('eraser-btn').classList.remove('active');
            document.getElementById('mode-indicator').textContent = 'üñåÔ∏è Áï´Á≠ÜÊ®°Âºè';

            if (typeof GameSound !== 'undefined') GameSound.play('click');
        }

        // Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupEventListeners() {
            // ÊªëÈº†‰∫ã‰ª∂
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Ëß∏Êéß‰∫ã‰ª∂
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            // Á≠ÜÂà∑Â§ßÂ∞è
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    brushSize = parseInt(btn.dataset.size);
                    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (typeof GameSound !== 'undefined') GameSound.play('click');
                });
            });

            // Ë¶ñÁ™óÂ§ßÂ∞èËÆäÂåñ
            window.addEventListener('resize', () => {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                setupCanvas();
                ctx.putImageData(imageData, 0, 0);
            });
        }

        // ÈñãÂßãÁπ™Áï´
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getPosition(e);
        }

        // Áπ™Áï´
        function draw(e) {
            if (!isDrawing) return;

            const [x, y] = getPosition(e);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = isEraser ? 'white' : currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();

            [lastX, lastY] = [x, y];
        }

        // ÂÅúÊ≠¢Áπ™Áï´
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveState();
            }
        }

        // ÂèñÂæó‰ΩçÁΩÆÔºàÊîØÊè¥ÊªëÈº†ÂíåËß∏ÊéßÔºâ
        function getPosition(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches) {
                return [
                    (e.touches[0].clientX - rect.left) * scaleX,
                    (e.touches[0].clientY - rect.top) * scaleY
                ];
            }
            return [
                (e.clientX - rect.left) * scaleX,
                (e.clientY - rect.top) * scaleY
            ];
        }

        // Ëß∏Êéß‰∫ã‰ª∂ËôïÁêÜ
        function handleTouchStart(e) {
            e.preventDefault();
            startDrawing(e);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            draw(e);
        }

        // ÂàáÊèõÊ©°ÁöÆÊì¶
        function toggleEraser() {
            isEraser = !isEraser;
            const btn = document.getElementById('eraser-btn');
            const indicator = document.getElementById('mode-indicator');

            if (isEraser) {
                btn.classList.add('active');
                indicator.textContent = 'üßΩ Ê©°ÁöÆÊì¶Ê®°Âºè';
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            } else {
                btn.classList.remove('active');
                indicator.textContent = 'üñåÔ∏è Áï´Á≠ÜÊ®°Âºè';
            }

            if (typeof GameSound !== 'undefined') GameSound.play('click');
        }

        // Ê∏ÖÈô§Áï´Â∏É
        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();

            if (typeof GameSound !== 'undefined') GameSound.play('pop');
            if (typeof GameAudio !== 'undefined') GameAudio.speak('Áï´Â∏ÉÂ∑≤Ê∏ÖÈô§ÔºÅ');
        }

        // ÂÑ≤Â≠òÁãÄÊÖãÔºàÁî®ÊñºÂæ©ÂéüÔºâ
        function saveState() {
            historyIndex++;
            history = history.slice(0, historyIndex);
            history.push(canvas.toDataURL());

            // ÈôêÂà∂Ê≠∑Âè≤Ë®òÈåÑÊï∏Èáè
            if (history.length > 20) {
                history.shift();
                historyIndex--;
            }
        }

        // Âæ©Âéü
        function undoLast() {
            if (historyIndex > 0) {
                historyIndex--;
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = history[historyIndex];

                if (typeof GameSound !== 'undefined') GameSound.play('click');
            }
        }

        // ÂÑ≤Â≠ò‰ΩúÂìÅ
        function saveDrawing() {
            const link = document.createElement('a');
            link.download = 'ÊàëÁöÑÂ°óÈ¥â‰ΩúÂìÅ_' + new Date().toLocaleDateString('zh-TW') + '.png';
            link.href = canvas.toDataURL();
            link.click();

            // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
            const msg = document.createElement('div');
            msg.className = 'save-success';
            msg.textContent = 'üéâ ‰ΩúÂìÅÂ∑≤ÂÑ≤Â≠òÔºÅ';
            document.body.appendChild(msg);

            setTimeout(() => msg.remove(), 2000);

            if (typeof GameSound !== 'undefined') GameSound.play('win');
            if (typeof GameAudio !== 'undefined') GameAudio.speak('Â§™Ê£í‰∫ÜÔºÅ‰ΩúÂìÅÂ∑≤ÂÑ≤Â≠òÔºÅ');
            if (typeof RewardSystem !== 'undefined') {
                RewardSystem.addStars(2);
            }
        }

        // È†ÅÈù¢ËºâÂÖ•
        window.onload = init;
    </script>
</body>

</html>