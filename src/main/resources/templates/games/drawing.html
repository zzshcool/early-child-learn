<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡—é´‰ç•«æ¿ - å¿«æ¨‚å­¸ç¿’æ¨‚åœ’</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/drawing.css}">
</head>

<body>
    <header>
        <h1>ğŸ¨ å¡—é´‰ç•«æ¿</h1>
    </header>
    <main>
        <div th:replace="~{fragments :: nav('/games/menu', 'â† ä¸Šä¸€é ')}"></div>

        <div class="drawing-container">
            <div class="mode-indicator" id="mode-indicator">ğŸ–Œï¸ ç•«ç­†æ¨¡å¼</div>

            <div class="canvas-wrapper">
                <canvas id="drawing-canvas" width="600" height="450"></canvas>
            </div>

            <div class="tools-panel">
                <div class="color-palette" id="color-palette">
                    <!-- é¡è‰²æŒ‰éˆ•ç”± JS ç”Ÿæˆ -->
                </div>
            </div>

            <div class="tools-panel">
                <div class="brush-sizes">
                    <span class="brush-label">ç­†åˆ·å¤§å°ï¼š</span>
                    <button class="size-btn size-small" data-size="5" title="å°"></button>
                    <button class="size-btn size-medium active" data-size="12" title="ä¸­"></button>
                    <button class="size-btn size-large" data-size="24" title="å¤§"></button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn btn-eraser" id="eraser-btn" onclick="toggleEraser()">ğŸ§½ æ©¡çš®æ“¦</button>
                <button class="action-btn btn-undo" onclick="undoLast()">â†©ï¸ å¾©åŸ</button>
                <button class="action-btn btn-clear" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…é™¤</button>
                <button class="action-btn btn-save" onclick="saveDrawing()">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments :: game-scripts}"></th:block>

    <script>
        // é¡è‰²å®šç¾©
        const colors = [
            { name: 'ç´…è‰²', hex: '#E74C3C' },
            { name: 'æ©˜è‰²', hex: '#E67E22' },
            { name: 'é»ƒè‰²', hex: '#F1C40F' },
            { name: 'ç¶ è‰²', hex: '#27AE60' },
            { name: 'è—è‰²', hex: '#3498DB' },
            { name: 'ç´«è‰²', hex: '#9B59B6' },
            { name: 'ç²‰ç´…', hex: '#FF69B4' },
            { name: 'æ£•è‰²', hex: '#8B4513' },
            { name: 'é»‘è‰²', hex: '#2C3E50' },
            { name: 'ç™½è‰²', hex: '#FFFFFF' }
        ];

        // ç•«å¸ƒç›¸é—œè®Šæ•¸
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#2C3E50';
        let brushSize = 12;
        let isEraser = false;
        let history = [];
        let historyIndex = -1;

        // åˆå§‹åŒ–
        function init() {
            setupCanvas();
            generateColorPalette();
            setupEventListeners();
            saveState();

            if (typeof RewardSystem !== 'undefined') {
                RewardSystem.createStarDisplay();
            }
            if (typeof GameAudio !== 'undefined') {
                GameAudio.speak('æ­¡è¿ä¾†åˆ°å¡—é´‰ç•«æ¿ï¼é¸æ“‡é¡è‰²é–‹å§‹ç•«ç•«å§ï¼');
            }
        }

        // è¨­ç½®ç•«å¸ƒå°ºå¯¸ï¼ˆéŸ¿æ‡‰å¼ï¼‰
        function setupCanvas() {
            const container = canvas.parentElement;
            const maxWidth = Math.min(600, window.innerWidth - 40);
            const ratio = 450 / 600;

            canvas.width = maxWidth;
            canvas.height = maxWidth * ratio;

            // è¨­å®šåˆå§‹èƒŒæ™¯ç‚ºç™½è‰²
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // ç”Ÿæˆé¡è‰²é¸æ“‡å™¨
        function generateColorPalette() {
            const palette = document.getElementById('color-palette');
            colors.forEach((color, index) => {
                const btn = document.createElement('button');
                btn.className = 'color-btn' + (color.hex === currentColor ? ' active' : '');
                btn.style.backgroundColor = color.hex;
                if (color.hex === '#FFFFFF') {
                    btn.style.border = '4px solid #ddd';
                }
                btn.title = color.name;
                btn.onclick = () => selectColor(color.hex, btn);
                palette.appendChild(btn);
            });
        }

        // é¸æ“‡é¡è‰²
        function selectColor(hex, btn) {
            currentColor = hex;
            isEraser = false;

            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('eraser-btn').classList.remove('active');
            document.getElementById('mode-indicator').textContent = 'ğŸ–Œï¸ ç•«ç­†æ¨¡å¼';

            if (typeof GameSound !== 'undefined') GameSound.play('click');
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æ»‘é¼ äº‹ä»¶
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // è§¸æ§äº‹ä»¶
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            // ç­†åˆ·å¤§å°
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    brushSize = parseInt(btn.dataset.size);
                    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (typeof GameSound !== 'undefined') GameSound.play('click');
                });
            });

            // è¦–çª—å¤§å°è®ŠåŒ–
            window.addEventListener('resize', () => {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                setupCanvas();
                ctx.putImageData(imageData, 0, 0);
            });
        }

        // é–‹å§‹ç¹ªç•«
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getPosition(e);
        }

        // ç¹ªç•«
        function draw(e) {
            if (!isDrawing) return;

            const [x, y] = getPosition(e);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = isEraser ? 'white' : currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();

            [lastX, lastY] = [x, y];
        }

        // åœæ­¢ç¹ªç•«
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveState();
            }
        }

        // å–å¾—ä½ç½®ï¼ˆæ”¯æ´æ»‘é¼ å’Œè§¸æ§ï¼‰
        function getPosition(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches) {
                return [
                    (e.touches[0].clientX - rect.left) * scaleX,
                    (e.touches[0].clientY - rect.top) * scaleY
                ];
            }
            return [
                (e.clientX - rect.left) * scaleX,
                (e.clientY - rect.top) * scaleY
            ];
        }

        // è§¸æ§äº‹ä»¶è™•ç†
        function handleTouchStart(e) {
            e.preventDefault();
            startDrawing(e);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            draw(e);
        }

        // åˆ‡æ›æ©¡çš®æ“¦
        function toggleEraser() {
            isEraser = !isEraser;
            const btn = document.getElementById('eraser-btn');
            const indicator = document.getElementById('mode-indicator');

            if (isEraser) {
                btn.classList.add('active');
                indicator.textContent = 'ğŸ§½ æ©¡çš®æ“¦æ¨¡å¼';
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            } else {
                btn.classList.remove('active');
                indicator.textContent = 'ğŸ–Œï¸ ç•«ç­†æ¨¡å¼';
            }

            if (typeof GameSound !== 'undefined') GameSound.play('click');
        }

        // æ¸…é™¤ç•«å¸ƒ
        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();

            if (typeof GameSound !== 'undefined') GameSound.play('pop');
            if (typeof GameAudio !== 'undefined') GameAudio.speak('ç•«å¸ƒå·²æ¸…é™¤ï¼');
        }

        // å„²å­˜ç‹€æ…‹ï¼ˆç”¨æ–¼å¾©åŸï¼‰
        function saveState() {
            historyIndex++;
            history = history.slice(0, historyIndex);
            history.push(canvas.toDataURL());

            // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
            if (history.length > 20) {
                history.shift();
                historyIndex--;
            }
        }

        // å¾©åŸ
        function undoLast() {
            if (historyIndex > 0) {
                historyIndex--;
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = history[historyIndex];

                if (typeof GameSound !== 'undefined') GameSound.play('click');
            }
        }

        // å„²å­˜ä½œå“
        function saveDrawing() {
            const link = document.createElement('a');
            link.download = 'æˆ‘çš„å¡—é´‰ä½œå“_' + new Date().toLocaleDateString('zh-TW') + '.png';
            link.href = canvas.toDataURL();
            link.click();

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const msg = document.createElement('div');
            msg.className = 'save-success';
            msg.textContent = 'ğŸ‰ ä½œå“å·²å„²å­˜ï¼';
            document.body.appendChild(msg);

            setTimeout(() => msg.remove(), 2000);

            if (typeof GameSound !== 'undefined') GameSound.play('win');
            if (typeof GameAudio !== 'undefined') GameAudio.speak('å¤ªæ£’äº†ï¼ä½œå“å·²å„²å­˜ï¼');
            if (typeof RewardSystem !== 'undefined') {
                RewardSystem.addStars(2);
            }
        }

        // é é¢è¼‰å…¥
        window.onload = init;
    </script>
</body>

</html>