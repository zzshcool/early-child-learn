<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼åœ–éŠæˆ² - å¿«æ¨‚å­¸ç¿’æ¨‚åœ’</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/puzzle.css}">
</head>

<body>
    <header>
        <h1>ğŸ§© æ‹¼åœ–éŠæˆ²</h1>
    </header>
    <main>
        <div th:replace="~{fragments :: nav('/games/menu', 'â† ä¸Šä¸€é ')}"></div>

        <div class="puzzle-container">
            <!-- ä¸»é¡Œé¸æ“‡ -->
            <div id="theme-selection">
                <h2 class="section-title difficulty">é¸æ“‡ä¸»é¡Œ</h2>
                <div class="theme-selection">
                    <button class="theme-btn" onclick="selectTheme('animals')">
                        <span class="theme-icon">ğŸ¾</span>
                        å¯æ„›å‹•ç‰©
                    </button>
                    <button class="theme-btn" onclick="selectTheme('fruits')">
                        <span class="theme-icon">ğŸ</span>
                        æ°´æœè”¬èœ
                    </button>
                    <button class="theme-btn" onclick="selectTheme('vehicles')">
                        <span class="theme-icon">ğŸš—</span>
                        äº¤é€šå·¥å…·
                    </button>
                </div>
            </div>

            <!-- é›£åº¦é¸æ“‡ -->
            <div id="difficulty-selection" class="hidden">
                <h2 class="section-title difficulty">é¸æ“‡é›£åº¦</h2>
                <div class="difficulty-selection">
                    <button class="difficulty-btn" onclick="selectDifficulty(2)">2Ã—2<br>(4ç‰‡)</button>
                    <button class="difficulty-btn" onclick="selectDifficulty(3)">3Ã—3<br>(9ç‰‡)</button>
                    <button class="difficulty-btn" onclick="selectDifficulty(4)">4Ã—4<br>(16ç‰‡)</button>
                </div>
                <button class="control-btn btn-back btn-margin-top" onclick="backToTheme()">ğŸ”™ è¿”å›ä¸»é¡Œ</button>
            </div>

            <!-- åœ–ç‰‡é¸æ“‡ -->
            <div id="image-selection" class="hidden">
                <h2 class="section-title image">é¸æ“‡åœ–ç‰‡</h2>
                <div class="image-grid" id="image-grid">
                    <!-- ç”± JS ç”Ÿæˆ -->
                </div>
                <button class="control-btn btn-back btn-margin-top" onclick="backToDifficulty()">ğŸ”™ è¿”å›é›£åº¦</button>
            </div>

            <!-- éŠæˆ²å€åŸŸ -->
            <div id="puzzle-area" class="puzzle-area">
                <div class="puzzle-info">
                    <span id="timer">00:00</span> | ç§»å‹•æ¬¡æ•¸ï¼š<span id="moves">0</span>
                </div>

                <div class="reference-container">
                    <img id="reference-img" class="reference-image-display" src="" alt="åƒè€ƒåœ–ç‰‡">
                </div>

                <div class="puzzle-grid" id="puzzle-grid">
                    <!-- æ‹¼åœ–å¡Šç”± JS ç”Ÿæˆ -->
                </div>

                <div class="controls puzzle-controls">
                    <button class="control-btn btn-shuffle" onclick="shufflePuzzle()">ğŸ”€ é‡æ–°æ´—ç‰Œ</button>
                    <button class="control-btn btn-hint" onclick="showHint()">ğŸ’¡ æç¤º</button>
                    <button class="control-btn btn-back" onclick="backToSelection()">ğŸ”™ è¿”å›é¸æ“‡</button>
                </div>
            </div>

            <!-- å‹åˆ©è¦†è“‹å±¤ -->
            <div id="win-overlay" class="win-overlay hidden">
                <div class="win-content">
                    <div class="win-emoji">ğŸ‰</div>
                    <div class="win-text">æ­å–œå®Œæˆæ‹¼åœ–ï¼</div>
                    <div class="win-time" id="win-time"></div>
                    <div class="controls puzzle-controls">
                        <button class="control-btn btn-shuffle" onclick="playAgain()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
                        <button class="control-btn btn-back" onclick="backToSelection()">ğŸ”™ é¸æ“‡å…¶ä»–</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments :: game-scripts}"></th:block>

    <script>
        // ä¸»é¡Œåœ–ç‰‡è³‡æ–™ï¼ˆä½¿ç”¨ emoji é…åˆå½©è‰²èƒŒæ™¯ç”Ÿæˆå¡é€šé¢¨æ ¼ï¼‰
        const themes = {
            animals: {
                name: 'å¯æ„›å‹•ç‰©',
                images: [
                    { id: 'cat', emoji: 'ğŸ±', bg: ['#FFE4E1', '#FFC0CB'], name: 'å°è²“' },
                    { id: 'dog', emoji: 'ğŸ¶', bg: ['#FFECD2', '#FCB69F'], name: 'å°ç‹—' },
                    { id: 'rabbit', emoji: 'ğŸ°', bg: ['#E0C3FC', '#8EC5FC'], name: 'å…”å­' },
                    { id: 'bear', emoji: 'ğŸ»', bg: ['#D4A574', '#E8C9A0'], name: 'å°ç†Š' },
                    { id: 'panda', emoji: 'ğŸ¼', bg: ['#C9D6FF', '#E2E2E2'], name: 'ç†Šè²“' },
                    { id: 'lion', emoji: 'ğŸ¦', bg: ['#FFD89B', '#FF8E53'], name: 'ç…å­' },
                    { id: 'monkey', emoji: 'ğŸµ', bg: ['#FFC371', '#FF5F6D'], name: 'çŒ´å­' },
                    { id: 'elephant', emoji: 'ğŸ˜', bg: ['#89CFF0', '#A0D2DB'], name: 'å¤§è±¡' },
                    { id: 'fox', emoji: 'ğŸ¦Š', bg: ['#FF9966', '#FF5E62'], name: 'ç‹ç‹¸' },
                    { id: 'penguin', emoji: 'ğŸ§', bg: ['#667DB6', '#0082C8'], name: 'ä¼éµ' }
                ]
            },
            fruits: {
                name: 'æ°´æœè”¬èœ',
                images: [
                    { id: 'apple', emoji: 'ğŸ', bg: ['#FF6B6B', '#FFE66D'], name: 'è˜‹æœ' },
                    { id: 'orange', emoji: 'ğŸŠ', bg: ['#FF9A44', '#FC6076'], name: 'æ©˜å­' },
                    { id: 'strawberry', emoji: 'ğŸ“', bg: ['#FF758C', '#FF7EB3'], name: 'è‰è“' },
                    { id: 'grape', emoji: 'ğŸ‡', bg: ['#9B59B6', '#E056FD'], name: 'è‘¡è„' },
                    { id: 'watermelon', emoji: 'ğŸ‰', bg: ['#11998E', '#38EF7D'], name: 'è¥¿ç“œ' },
                    { id: 'banana', emoji: 'ğŸŒ', bg: ['#F7DC6F', '#F9E79F'], name: 'é¦™è•‰' },
                    { id: 'cherry', emoji: 'ğŸ’', bg: ['#E91E63', '#FF5252'], name: 'æ«»æ¡ƒ' },
                    { id: 'peach', emoji: 'ğŸ‘', bg: ['#FFAB91', '#FFCCBC'], name: 'æ¡ƒå­' },
                    { id: 'pineapple', emoji: 'ğŸ', bg: ['#FFEB3B', '#FFC107'], name: 'é³³æ¢¨' },
                    { id: 'carrot', emoji: 'ğŸ¥•', bg: ['#FF7043', '#FFAB91'], name: 'ç´…è˜¿è””' }
                ]
            },
            vehicles: {
                name: 'äº¤é€šå·¥å…·',
                images: [
                    { id: 'car', emoji: 'ğŸš—', bg: ['#667EEA', '#764BA2'], name: 'æ±½è»Š' },
                    { id: 'bus', emoji: 'ğŸšŒ', bg: ['#F093FB', '#F5576C'], name: 'å…¬è»Š' },
                    { id: 'train', emoji: 'ğŸš‚', bg: ['#4ECDC4', '#556270'], name: 'ç«è»Š' },
                    { id: 'plane', emoji: 'âœˆï¸', bg: ['#00C6FF', '#0072FF'], name: 'é£›æ©Ÿ' },
                    { id: 'ship', emoji: 'ğŸš¢', bg: ['#2193B0', '#6DD5ED'], name: 'è¼ªèˆ¹' },
                    { id: 'rocket', emoji: 'ğŸš€', bg: ['#8E2DE2', '#4A00E0'], name: 'ç«ç®­' },
                    { id: 'helicopter', emoji: 'ğŸš', bg: ['#56CCF2', '#2F80ED'], name: 'ç›´å‡æ©Ÿ' },
                    { id: 'bicycle', emoji: 'ğŸš²', bg: ['#38EF7D', '#11998E'], name: 'è…³è¸è»Š' },
                    { id: 'motorcycle', emoji: 'ğŸï¸', bg: ['#F2994A', '#F2C94C'], name: 'æ‘©æ‰˜è»Š' },
                    { id: 'tractor', emoji: 'ğŸšœ', bg: ['#56AB2F', '#A8E063'], name: 'æ‹–æ‹‰æ©Ÿ' }
                ]
            }
        };

        let currentTheme = null;
        let gridSize = 3;
        let selectedImage = null;
        let loadedImage = null;
        let pieces = [];
        let selectedPiece = null;
        let moves = 0;
        let startTime = null;
        let timerInterval = null;
        let isGameActive = false;

        // å‹•æ…‹ç”Ÿæˆå¡é€šåœ–ç‰‡
        function generateCartoonImage(imgData) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');

                // ç¹ªè£½æ¼¸å±¤èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, 400, 400);
                gradient.addColorStop(0, imgData.bg[0]);
                gradient.addColorStop(1, imgData.bg[1]);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 400);

                // ç¹ªè£½è£é£¾åœ“åœˆ
                ctx.globalAlpha = 0.3;
                for (let i = 0; i < 5; i++) {
                    ctx.beginPath();
                    ctx.arc(Math.random() * 400, Math.random() * 400, 30 + Math.random() * 50, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffffff';
                    ctx.fill();
                }
                ctx.globalAlpha = 1;

                // ç¹ªè£½ emojiï¼ˆå¤§å°ºå¯¸ï¼‰
                ctx.font = '180px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(imgData.emoji, 200, 200);

                // è½‰æ›ç‚ºåœ–ç‰‡
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = canvas.toDataURL();
            });
        }

        // åˆå§‹åŒ–
        function init() {
            if (typeof RewardSystem !== 'undefined') {
                RewardSystem.createStarDisplay();
            }
            if (typeof GameAudio !== 'undefined') {
                GameAudio.speak('æ­¡è¿ä¾†åˆ°æ‹¼åœ–éŠæˆ²ï¼é¸æ“‡ä¸»é¡Œé–‹å§‹ï¼');
            }
        }

        // é¸æ“‡ä¸»é¡Œ
        function selectTheme(themeId) {
            currentTheme = themes[themeId];
            document.getElementById('theme-selection').classList.add('hidden');
            document.getElementById('difficulty-selection').classList.remove('hidden');
            if (typeof GameSound !== 'undefined') GameSound.play('click');
            if (typeof GameAudio !== 'undefined') {
                GameAudio.speak(`é¸æ“‡äº†${currentTheme.name}ä¸»é¡Œï¼è«‹é¸æ“‡é›£åº¦ã€‚`);
            }
        }

        // è¿”å›ä¸»é¡Œé¸æ“‡
        function backToTheme() {
            document.getElementById('difficulty-selection').classList.add('hidden');
            document.getElementById('theme-selection').classList.remove('hidden');
        }

        // é¸æ“‡é›£åº¦
        function selectDifficulty(size) {
            gridSize = size;
            document.getElementById('difficulty-selection').classList.add('hidden');
            document.getElementById('image-selection').classList.remove('hidden');
            generateImageGrid();
            if (typeof GameSound !== 'undefined') GameSound.play('click');
        }

        // è¿”å›é›£åº¦é¸æ“‡
        function backToDifficulty() {
            document.getElementById('image-selection').classList.add('hidden');
            document.getElementById('difficulty-selection').classList.remove('hidden');
        }

        // ç”Ÿæˆåœ–ç‰‡é¸æ“‡ç¶²æ ¼
        function generateImageGrid() {
            const grid = document.getElementById('image-grid');
            grid.innerHTML = '';

            currentTheme.images.forEach(async (img) => {
                const div = document.createElement('div');
                div.className = 'image-option';

                // ä½¿ç”¨ Canvas ç”Ÿæˆé è¦½åœ–
                const previewCanvas = document.createElement('canvas');
                previewCanvas.width = 120;
                previewCanvas.height = 120;
                const ctx = previewCanvas.getContext('2d');

                // ç¹ªè£½æ¼¸å±¤èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, 120, 120);
                gradient.addColorStop(0, img.bg[0]);
                gradient.addColorStop(1, img.bg[1]);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 120, 120);

                // ç¹ªè£½ emoji
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(img.emoji, 60, 60);

                div.appendChild(previewCanvas);
                div.onclick = () => selectImage(img);
                grid.appendChild(div);
            });
        }

        // é¸æ“‡åœ–ç‰‡
        async function selectImage(img) {
            selectedImage = img;
            document.getElementById('image-selection').classList.add('hidden');
            document.getElementById('puzzle-area').style.display = 'flex';

            // ä½¿ç”¨ Canvas ç”Ÿæˆå¡é€šåœ–ç‰‡
            loadedImage = await generateCartoonImage(img);

            // è¨­ç½®åƒè€ƒåœ–ç‰‡
            document.getElementById('reference-img').src = loadedImage.src;

            initPuzzle();

            if (typeof GameAudio !== 'undefined') {
                GameAudio.speak(`é¸æ“‡äº†${img.name}ï¼é–‹å§‹æ‹¼åœ–ï¼`);
            }
        }

        // åˆå§‹åŒ–æ‹¼åœ–
        function initPuzzle() {
            const grid = document.getElementById('puzzle-grid');
            const containerWidth = Math.min(360, window.innerWidth - 40);
            const pieceSize = Math.floor(containerWidth / gridSize);

            grid.style.gridTemplateColumns = `repeat(${gridSize}, ${pieceSize}px)`;
            grid.innerHTML = '';

            // å‰µå»ºæ‹¼åœ–å¡Š
            pieces = [];
            const totalPieces = gridSize * gridSize;

            for (let i = 0; i < totalPieces; i++) {
                pieces.push({ id: i, currentPos: i, correctPos: i });
            }

            // æ´—ç‰Œ
            shuffleArray();
            renderPuzzle();

            // é‡ç½®ç‹€æ…‹
            moves = 0;
            document.getElementById('moves').textContent = '0';
            startTime = Date.now();
            isGameActive = true;

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        // æ´—ç‰Œé™£åˆ—
        function shuffleArray() {
            const positions = pieces.map((_, i) => i);
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }
            pieces.forEach((piece, index) => {
                piece.currentPos = positions[index];
            });
        }

        // æ¸²æŸ“æ‹¼åœ–
        function renderPuzzle() {
            const grid = document.getElementById('puzzle-grid');
            const containerWidth = Math.min(360, window.innerWidth - 40);
            const pieceSize = Math.floor(containerWidth / gridSize);
            grid.innerHTML = '';

            // æŒ‰ç•¶å‰ä½ç½®æ’åº
            const sortedPieces = [...pieces].sort((a, b) => a.currentPos - b.currentPos);

            sortedPieces.forEach(piece => {
                const canvas = document.createElement('canvas');
                canvas.className = 'puzzle-piece-canvas';
                canvas.width = pieceSize;
                canvas.height = pieceSize;
                canvas.dataset.id = piece.id;

                // ç¹ªè£½åœ–ç‰‡åˆ‡ç‰‡
                const ctx = canvas.getContext('2d');
                const srcSize = loadedImage.width / gridSize;
                const row = Math.floor(piece.id / gridSize);
                const col = piece.id % gridSize;

                ctx.drawImage(
                    loadedImage,
                    col * srcSize, row * srcSize,
                    srcSize, srcSize,
                    0, 0,
                    pieceSize, pieceSize
                );

                // æ­£ç¢ºä½ç½®æ¨™è¨˜
                if (piece.currentPos === piece.correctPos) {
                    canvas.classList.add('correct');
                }

                canvas.onclick = () => handlePieceClick(piece, canvas);
                grid.appendChild(canvas);
            });
        }

        // æ´—ç‰Œ
        function shufflePuzzle() {
            shuffleArray();
            renderPuzzle();
            if (typeof GameSound !== 'undefined') GameSound.play('pop');
        }

        // è™•ç†æ‹¼åœ–å¡Šé»æ“Š
        function handlePieceClick(piece, canvas) {
            if (!isGameActive) return;

            if (selectedPiece === null) {
                selectedPiece = { piece, canvas };
                canvas.classList.add('selected');
                if (typeof GameSound !== 'undefined') GameSound.play('click');
            } else if (selectedPiece.piece.id === piece.id) {
                canvas.classList.remove('selected');
                selectedPiece = null;
            } else {
                // äº¤æ›ä½ç½®
                const temp = selectedPiece.piece.currentPos;
                selectedPiece.piece.currentPos = piece.currentPos;
                piece.currentPos = temp;

                selectedPiece.canvas.classList.remove('selected');
                selectedPiece = null;
                moves++;
                document.getElementById('moves').textContent = moves;

                renderPuzzle();
                if (typeof GameSound !== 'undefined') GameSound.play('pop');
                checkWin();
            }
        }

        // æª¢æŸ¥æ˜¯å¦å‹åˆ©
        function checkWin() {
            const isComplete = pieces.every(p => p.currentPos === p.correctPos);

            if (isComplete) {
                isGameActive = false;
                clearInterval(timerInterval);

                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;

                document.getElementById('win-time').textContent =
                    `ç”¨æ™‚ï¼š${minutes}åˆ†${seconds}ç§’ | ç§»å‹•ï¼š${moves}æ¬¡`;
                document.getElementById('win-overlay').classList.remove('hidden');

                if (typeof GameSound !== 'undefined') GameSound.play('win');
                if (typeof GameAudio !== 'undefined') {
                    GameAudio.speak('å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†æ‹¼åœ–ï¼');
                }
                if (typeof RewardSystem !== 'undefined') {
                    RewardSystem.addStars(gridSize);
                    RewardSystem.recordGameComplete('cognitive');
                }
            }
        }

        // æ›´æ–°è¨ˆæ™‚å™¨
        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // é¡¯ç¤ºæç¤º
        function showHint() {
            const wrongPiece = pieces.find(p => p.currentPos !== p.correctPos);
            if (wrongPiece) {
                if (typeof GameAudio !== 'undefined') {
                    const row = Math.floor(wrongPiece.correctPos / gridSize) + 1;
                    const col = wrongPiece.correctPos % gridSize + 1;
                    GameAudio.speak(`æç¤ºï¼šæ‰¾åˆ°æ”¾éŒ¯ä½ç½®çš„æ‹¼åœ–å¡Šï¼`);
                }
            }
            if (typeof GameSound !== 'undefined') GameSound.play('click');
        }

        // å†ç©ä¸€æ¬¡
        function playAgain() {
            document.getElementById('win-overlay').classList.add('hidden');
            initPuzzle();
        }

        // è¿”å›é¸æ“‡
        function backToSelection() {
            document.getElementById('win-overlay').classList.add('hidden');
            document.getElementById('puzzle-area').style.display = 'none';
            document.getElementById('image-selection').classList.add('hidden');
            document.getElementById('difficulty-selection').classList.add('hidden');
            document.getElementById('theme-selection').classList.remove('hidden');

            if (timerInterval) clearInterval(timerInterval);
            isGameActive = false;
        }

        // é é¢è¼‰å…¥
        window.onload = init;
    </script>
</body>

</html>