<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–åƒè¨˜æ†¶ - å¿«æ¨‚å­¸ç¿’æ¨‚åœ’</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .game-container {
            text-align: center;
            margin-top: 20px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 20px auto;
        }

        .memory-card {
            background-color: #fff;
            border: 3px solid #FFD700;
            border-radius: 15px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .memory-card.flipped {
            background-color: #FFD700;
            color: transparent;
        }

        .memory-card:hover {
            transform: scale(1.05);
        }

        .target-display {
            font-size: 2rem;
            margin: 20px;
            padding: 15px;
            background-color: #e0f7fa;
            border-radius: 10px;
            display: inline-block;
        }

        .message {
            font-size: 1.5rem;
            margin: 20px;
            min-height: 40px;
            color: #333;
        }

        .hidden {
            display: none;
        }

        .btn-restart {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-restart:hover {
            background-color: #45a049;
        }

        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .shake {
            animation: shake 0.5s;
            border-color: #ff5252;
        }

        .countdown-big {
            font-size: 3rem;
            font-weight: bold;
            color: #FF6B6B;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - å¹³æ¿ */
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                max-width: 100%;
                padding: 0 10px;
            }

            .memory-card {
                height: 100px;
                font-size: 2.5rem;
            }

            .target-display {
                font-size: 1.5rem;
                padding: 10px;
                margin: 10px;
            }

            .message {
                font-size: 1.2rem;
                margin: 10px;
            }

            .countdown-big {
                font-size: 2.5rem;
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - æ‰‹æ©Ÿ */
        @media (max-width: 480px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .memory-card {
                height: 80px;
                font-size: 2rem;
                border-radius: 10px;
            }

            .target-display {
                font-size: 1.3rem;
                padding: 8px;
                margin: 8px;
            }

            .message {
                font-size: 1rem;
                margin: 8px;
            }

            .countdown-big {
                font-size: 2rem;
            }

            .btn-restart {
                padding: 8px 16px;
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>åœ–åƒè¨˜æ†¶ç¿»ç¿»å¡</h1>
    </header>
    <main>
        <div th:replace="~{fragments :: nav('/cognitive/menu', 'ä¸Šä¸€é ')}"></div>
        <div class="game-container">
            <div id="target-container">
                <div class="target-display">
                    è«‹è¨˜ä½ï¼š<span id="target-emoji"></span>
                </div>
            </div>
            <div id="instruction" class="message">è¨˜ä½é€™å€‹åœ–ç‰‡çš„ä½ç½®ï¼</div>

            <div class="cards-grid" id="cards-grid">
                <!-- Cards will be generated here -->
            </div>

            <button id="restart-btn" class="btn-restart hidden" onclick="initGame()">å†ç©ä¸€æ¬¡</button>
        </div>
    </main>

    <th:block th:replace="~{fragments :: game-scripts}"></th:block>

    <script>
        const emojis = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”'];
        let currentCards = [];
        let targetCard = null;
        let isGameActive = false;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame() {
            const grid = document.getElementById('cards-grid');
            const instruction = document.getElementById('instruction');
            const targetContainer = document.getElementById('target-container');
            const targetEmoji = document.getElementById('target-emoji');
            const restartBtn = document.getElementById('restart-btn');

            grid.innerHTML = '';
            targetContainer.classList.remove('hidden');
            restartBtn.classList.add('hidden');
            instruction.textContent = 'è¨˜ä½é€™å€‹åœ–ç‰‡çš„ä½ç½®ï¼';
            instruction.style.color = '#333';

            // Randomly select 4 to 8 cards
            const numCards = Math.floor(Math.random() * 5) + 4; // 4 to 8
            const gameEmojis = shuffle([...emojis]).slice(0, numCards);

            currentCards = gameEmojis.map((emoji, index) => ({
                id: index,
                emoji: emoji
            }));

            // Select target first (before showing cards)
            const randomIndex = Math.floor(Math.random() * currentCards.length);
            targetCard = currentCards[randomIndex];
            targetEmoji.textContent = targetCard.emoji;

            // Render cards (face-up initially)
            currentCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'memory-card';
                cardEl.textContent = card.emoji;
                cardEl.dataset.id = card.id;
                cardEl.onclick = () => handleCardClick(cardEl, card);
                grid.appendChild(cardEl);
            });

            isGameActive = false;

            // Countdown 6 seconds
            let countdown = 6;
            instruction.innerHTML = `<span class="countdown-big">å€’æ•¸ ${countdown} ç§’</span>`;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    instruction.innerHTML = `<span class="countdown-big">å€’æ•¸ ${countdown} ç§’</span>`;
                } else {
                    clearInterval(timer);
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            const cards = document.querySelectorAll('.memory-card');
            cards.forEach(card => card.classList.add('flipped'));

            const instruction = document.getElementById('instruction');
            const targetContainer = document.getElementById('target-container');

            // Hide the target hint
            targetContainer.classList.add('hidden');
            instruction.textContent = 'åœ–ç‰‡åœ¨å“ªè£¡ï¼Ÿé»é¸æ‰¾å‡ºä¾†ï¼';
            instruction.style.color = '#333';

            isGameActive = true;
        }

        function handleCardClick(cardEl, card) {
            if (!isGameActive) return;
            // If already revealed, ignore
            if (!cardEl.classList.contains('flipped')) return;

            // Reveal the card
            cardEl.classList.remove('flipped');

            GameSound.play('click');

            if (card.id === targetCard.id) {
                cardEl.style.backgroundColor = '#4CAF50';
                cardEl.style.color = 'white';

                const instruction = document.getElementById('instruction');
                instruction.textContent = 'ç­”å°äº†ï¼å¤ªæ£’äº†ï¼ğŸ‰';
                instruction.style.color = '#4CAF50';

                isGameActive = false;
                document.getElementById('restart-btn').classList.remove('hidden');

                GameSound.play('correct');
                GameAudio.correct();
                RewardSystem.addStars(2);
                RewardSystem.recordGameComplete('memory');

                setTimeout(() => {
                    document.querySelectorAll('.memory-card').forEach(c => c.classList.remove('flipped'));
                }, 1000);
            } else {
                isGameActive = false;
                cardEl.classList.add('shake');

                const instruction = document.getElementById('instruction');
                instruction.textContent = 'éŒ¯äº†ï¼å†è©¦ä¸€æ¬¡ï¼';
                instruction.style.color = '#ff5252';
                GameSound.play('wrong');

                setTimeout(() => {
                    cardEl.classList.remove('shake');
                    cardEl.classList.add('flipped');
                    instruction.textContent = 'åœ–ç‰‡åœ¨å“ªè£¡ï¼Ÿé»é¸æ‰¾å‡ºä¾†ï¼';
                    instruction.style.color = '#333';
                    isGameActive = true;
                }, 800);
            }
        }

        window.onload = function () {
            GameAudio.speak('æ­¡è¿ä¾†åˆ°åœ–åƒè¨˜æ†¶éŠæˆ²ï¼');
            setTimeout(initGame, 1500);
        };
    </script>
</body>

</html>